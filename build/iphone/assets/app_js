Ti.include("scripts/TiUtils.js"),Ti.include("screens/home.js"),Ti.include("screens/settingsMenu.js"),Ti.include("screens/editMenu.js"),Ti.include("addQuote.js");var mainWindow=Ti.UI.createWindow({backgroundColor:"#000",backgroundImage:"images/bg.png",statusBarStyle:Titanium.UI.iPhone.StatusBar.LIGHT_CONTENT,fullscreen:!0}),App={data:{showQuoteEditorInited:!1,iphoneVersionNumber:"1.1",ipadVersionNumber:"1.0",androidVersionNumber:"0.96",ACTION_DELETED:"QuoteDeleted",ACTION_LOADED:"QuotesLoaded",currentQuote:{},iPhoneStatusBarHeight:0,width:1,height:1,currMode:"chooser",orientation:"portrait",action:"",uiWinOpen:"",orientationModes:[Ti.UI.LANDSCAPE_LEFT,Ti.UI.LANDSCAPE_RIGHT,Ti.UI.PORTRAIT,Ti.UI.UPSIDE_PORTRAIT],inited:!1,memorizedQuotesArray:[],quoteFontSize:20,buttonbarHeight:50,toolbarHeight:40,closeBtnHeight:30,previousQuoteText:"<",nextQuoteText:">",uiWindowBgImage:"images/iphone-images/bg.png"},ui:{quoteWin:{},webview:{},buttonbar:{},buttonbarView:{},uiWin:{},htmlWin:{},settingsMenu:{},editMenu:{},prevQuoteBtn:{},nextQuoteBtn:{},hideWordsBtn:{},showAllWordsBtn:{}},styles:{fontFamily:"Helvetica Neue",buttonGradient:{type:"linear",colors:["#FEFEFE","#898989"],startPoint:{x:0,y:0},endPoint:{x:2,y:50},backFillStart:!1},toobarGradient:{type:"linear",colors:["#888888","#000001"],startPoint:{x:0,y:0},endPoint:{x:2,y:60},backFillStart:!1},gameBtnBgColor:"#666666"},init:function(){Ti.API.info("init1"),App.data.width=Ti.Platform.displayCaps.platformWidth,TiUtils.isAndroid()?(App.data.height=Ti.Platform.displayCaps.platformHeight,Ti.App.Properties.setString("appVersionNumber_preference",App.data.androidVersionNumber)):App.data.height=Ti.Platform.displayCaps.platformHeight,Ti.App.Properties.setString("currMode_preference","chooser"),mainWindow.orientationModes=App.data.orientationModes,Ti.API.info("init2"),TiUtils.isiPhone()&&Ti.App.Properties.setString("appVersionNumber_preference",App.data.iphoneVersionNumber),TiUtils.isiPad()&&(App.data.quoteFontSize=30,App.data.buttonbarHeight=80,App.data.toolbarHeight=60,App.data.closeBtnHeight=40,App.data.previousQuoteText="< Previous Quote",App.data.nextQuoteText="Next Quote >",Ti.App.Properties.setString("appVersionNumber_preference",App.data.ipadVersionNumber),App.data.uiWindowBgImage="images/ipad-images/bg.png"),Ti.App.Properties.setString("fontSize_preference",App.data.quoteFontSize),Ti.App.Properties.setString("currQuoteLanguage_preference","English"),Ti.App.Properties.setString("languageRowIndex_preference","5"),Ti.UI.setBackgroundColor("#000"),App.draw()}};Ti.API.info("start"),App.draw=function(){mainWindow.open(),Ti.API.info("draw1"),App.ui.webview=Ti.UI.createWebView({url:"index.html",disableBounce:!0}),Ti.API.info("draw2"),Ti.API.info("draw3"),Ti.API.info("draw4"),App.ui.buttonbar=Ti.UI.createButtonBar({id:"buttonbar",height:App.data.buttonbarHeight,labels:[App.data.previousQuoteText,"Hide Words","Show All",App.data.nextQuoteText],backgroundColor:"#CCCCCC",style:Ti.UI.iPhone.SystemButtonStyle.BAR}),Ti.API.info("draw5"),this.setListeners(),App.showHome(),mainWindow.add(App.ui.webview),mainWindow.backgroundImage=""},App.setListeners=function(){Ti.API.info("setListeners1"),TiUtils.isAndroid()||App.ui.buttonbar.addEventListener("click",App.handleButtonbarClick),Ti.App.addEventListener("showGame",App.handleTitaniumShowGame),Ti.App.addEventListener("hideGame",App.handleTitaniumHideGame),Ti.App.addEventListener("showHome",App.showHome),Ti.App.addEventListener("addQuote",App.handleTitaniumAddQuote),Ti.App.addEventListener("closeAddQuote",App.handleTitaniumCloseAddQuote),Ti.App.addEventListener("editQuote",App.handleTitaniumEditQuote),Ti.App.addEventListener("enterQuote",App.handleTitaniumEnterQuote),Ti.App.addEventListener("appLoaded",App.handleTitaniumAppLoaded),Ti.App.addEventListener("setCurrentQuote",App.handleTitaniumSetCurrentQuote),Ti.App.addEventListener("openQuoteURL",App.handleTitaniumOpenQuoteURL),Ti.App.addEventListener("memorizedArrayChange",App.handleTitaniumMemorizedArrayChange),Ti.App.addEventListener("fireAlert",App.handleTitaniumFireAlert),Ti.App.addEventListener("closeInstructions",App.handleTitaniumCloseInstructions),Ti.App.addEventListener("AddAndMemorize",App.handleSaveAndMemorize),Ti.App.addEventListener("emailQuoteEvent",App.emailQuote),Ti.App.addEventListener("copyQuoteEvent",App.copyQuoteToClipboard),Ti.App.addEventListener("closeEditMenuEvent",App.closeEditMenu),Ti.App.addEventListener("showQuoteEditorEvent",App.showQuoteEditor),Ti.App.addEventListener("deleteQuoteEvent",App.deleteQuote),Ti.App.addEventListener("sendFeedback",App.showEmailUsDialog),Ti.App.addEventListener("showQuoteSelector",App.showQuoteSelector),Ti.Network.addEventListener("change",App.handleTitaniumNetworkChange),Ti.Gesture.addEventListener("orientationchange",App.handleTitaniumOrientationChange),Ti.API.info("setListeners2")},Ti.API.info("start2"),App.showQuoteSelector=function(){App.ui.webview.visible=!0,Home.hideHome()},App.updateLayout=function(){Ti.API.info("updateLayout: App.data.currMode: "+App.data.currMode);var e=TiUtils.getAppHeight(),t=TiUtils.getAppWidth();Ti.API.info("App.data.width: "+t),Ti.API.info("App.data.height: "+e);try{"chooser"==App.data.currMode?App.ui.webview.height=e:(App.ui.webview.height=e-App.ui.buttonbar.height,App.ui.buttonbar.top=App.ui.webview.height),App.ui.uiWin.height=e,App.ui.uiWin.width=t,App.ui.htmlWin.height=e,App.ui.htmlWin.width=t}catch(o){Ti.API.info("error in the setting")}App.ui.webview.top=0,Ti.API.info("updateLayout2")},App.showQuoteEditor=function(){App.showQuoteEditorInited||(Ti.API.info("showQuoteEditor()"),AddQuote.showQuoteEditor(),Home.hideHome()),App.showQuoteEditorInited=!0},App.hideQuoteEditor=function(){AddQuote.hideQuoteEditor(),App.showQuoteEditorInited=!1},App.showInstructions=function(){App.openUiWindow("instructions.html",!0,!0)},App.showAbout=function(){App.openUiWindow("about.html",!0,!0)},App.showHome=function(){Ti.API.info("showhome1"),App.ui.webview.visible=!1,Home.showHome()},Ti.API.info("start3"),App.openUiWindow=function(e,t,o){Ti.API.info("openUiWindow()");var i=TiUtils.getAppHeight(),d=TiUtils.getAppWidth();if(App.data.uiWinOpen=!0,o?App.ui.htmlWin=Ti.UI.createWebView({url:e,width:d,height:i}):(App.ui.htmlWin=Ti.UI.createWindow({url:e,width:d,height:i,backgroundImage:App.data.uiWindowBgImage,statusBarStyle:Titanium.UI.iPhone.StatusBar.LIGHT_CONTENT,fullscreen:!0}),App.ui.htmlWin.open()),Ti.API.info("openUiWindow()2"),App.ui.uiWin=Ti.UI.createView({backgroundColor:"#000000",width:d,height:i}),App.ui.htmlWin.orientationModes=App.data.orientationModes,t){App.ui.htmlWin.top=40,App.ui.htmlWin.height=App.data.height-40;var n=Ti.UI.createView({width:App.data.width,height:App.data.toolbarHeight,top:0,backgroundGradient:App.styles.toobarGradient,borderWidth:1,borderColor:"#666"}),a=Ti.UI.createButton({title:"Close",width:100,height:App.data.closeBtnHeight,top:5,style:Ti.UI.iPhone.SystemButtonStyle.PLAIN,backgroundGradient:App.styles.buttonGradient,borderRadius:10,color:"#545454",font:{fontSize:16,fontFamily:App.styles.fontFamily,fontWeight:"bold"}});a.addEventListener("click",function(){try{mainWindow.remove(App.ui.uiWin)}catch(e){Ti.API.info("houston we have a problem")}}),n.add(a),App.ui.uiWin.add(n)}App.ui.uiWin.add(App.ui.htmlWin),App.ui.uiWin.backgroundImage=App.data.uiWindowBgImage},App.closeUIWindow=function(){Ti.API.info("closeUIWindow()1"),App.data.uiWinOpen&&mainWindow.remove(App.ui.uiWin),App.data.uiWinOpen=!1,Ti.API.info("closeUIWindow()2")},App.openSettingsMenu=function(){Titanium.API.info("openSettingsMenu()"),SettingsMenu.showSettings()},App.openEditMenu=function(){Titanium.API.info("openEditMenu()"),EditMenu.showMenu()},App.closeEditMenu=function(){EditMenu.hideMenu()},App.deleteQuote=function(){App.data.action=App.data.ACTION_DELETED;var e=App.data.currentQuote.id,t=Ti.Database.open("iMemorizeDB"),o=t.execute('SELECT * FROM MYQUOTES WHERE QUOTE_ID = "'+e+'"');Ti.API.info("Start ROW COUNT = "+o.getRowCount()),t.execute('DELETE FROM MYQUOTES WHERE QUOTE_ID = "'+e+'"'),o=t.execute('SELECT * FROM MYQUOTES WHERE QUOTE_ID = "'+e+'"'),Ti.API.info("End ROW COUNT = "+o.getRowCount()),t.close(),App.buildSavedQuotes(),App.removeIdFromMemorizedArray(e),TiUtils.showAlertDialog("Done","The quote has been deleted",["OK"])},App.loadQuotes=function(){App.data.action=App.data.ACTION_LOADED,this.buildSavedQuotes()},App.buildSavedQuotes=function(){Ti.API.info("buildSavedQuotes()");var e=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,"savedQuotes.xml");e.exists()||Ti.API.info("File "+e.name+" does not exist yet."),Ti.API.info("writeable = "+e.writeable),Ti.API.info("readonly = "+e.readonly);var t=Ti.Database.open("iMemorizeDB"),o=t.execute("SELECT * FROM MYQUOTES");Ti.API.info("ROW COUNT = "+o.getRowCount());for(var i='<?xml version="1.0" encoding="utf-8"?><quotes><section name="Saved Quotes">';o.isValidRow();)i+="<quote id='"+o.fieldByName("quote_id")+"'><text>"+o.fieldByName("quote")+"</text><author>"+o.fieldByName("author")+"</author><reference>"+o.fieldByName("source")+"</reference><language>"+o.fieldByName("language")+"</language><checked>"+o.fieldByName("checked")+"</checked></quote>",Ti.API.info("ID: "+o.field(0)+" Quote: "+o.fieldByName("quote")+" Language "+o.fieldByName("language")),o.next();i+="</section></quotes>",o.close(),t.close(),e.write(i);var d=e.read();Ti.API.info("NOW contents text = "+d.text),Ti.App.fireEvent(App.data.action,{data:d.text})},Ti.API.info("start4"),App.handleButtonbarClick=function(e){0===e.index&&Ti.App.fireEvent("loadPrevQuote",{}),1===e.index&&Ti.App.fireEvent("hideWords",{}),2===e.index&&Ti.App.fireEvent("showAllWords",{}),3===e.index&&Ti.App.fireEvent("loadNextQuote",{})},App.handleTitaniumShowGame=function(){App.data.currMode="game",Ti.App.Properties.setString("currMode_preference","game"),App.showGameButtons(),App.updateLayout(),Ti.API.info("showGame"),setTimeout(App.updateLayout,100)},App.handleTitaniumFireAlert=function(e){TiUtils.showAlertDialog(e.title,e.text,e.buttons)},App.handleTitaniumHideGame=function(){Ti.API.info("hideGame"),App.data.currMode="chooser",Ti.App.Properties.setString("currMode_preference","chooser");try{Ti.API.info("buttonbar: "+App.ui.buttonbar),Ti.API.info("inside hideGame try block"),App.hideGameButtons()}catch(e){Ti.API.info("could not remove button bar")}App.updateLayout(),setTimeout(App.updateLayout,100)},App.handleTitaniumAddQuote=function(){Ti.API.info("addQuote"),Ti.App.Properties.setString("quoteEditAction_preference","add"),App.openSettingsMenu()},App.handleTitaniumCloseAddQuote=function(){Ti.API.info("closeAddQuote"),AddQuote.hideQuoteEditor()},App.handleTitaniumEditQuote=function(e){Ti.API.info("editQuote ID: "+e.data),Ti.App.Properties.setString("quoteID_preference",e.data),Ti.App.Properties.setString("quoteEditAction_preference","edit"),App.openEditMenu()},App.handleTitaniumEnterQuote=function(){Ti.App.Properties.setString("quoteEditAction_preference","add"),App.ui.webview.visible=!0,App.showQuoteEditor()},App.handleTitaniumAppLoaded=function(){Ti.API.info(">>>>>>>>>>appLoaded");var e=Ti.Database.open("iMemorizeDB");e.execute("CREATE TABLE IF NOT EXISTS MYQUOTES (ID INTEGER PRIMARY KEY AUTOINCREMENT, QUOTE_ID TEXT, QUOTE TEXT, AUTHOR TEXT, SOURCE TEXT, LANGUAGE TEXT, CHECKED INTEGER)"),e.close(),App.loadQuotes(),App.sendMemorizedArray(),App.data.inited&&App.closeUIWindow(),App.data.inited=!0;var t=Ti.Network.online;Ti.App.fireEvent("networkOnline",{online:t})},App.handleTitaniumSetCurrentQuote=function(e){App.data.currentQuote=e.data},App.handleTitaniumOpenQuoteURL=function(){Ti.Platform.openURL(App.data.currentQuote.url)},App.handleTitaniumMemorizedArrayChange=function(e){Ti.API.info("MemorizedArrayChange: "+e.data),App.data.memorizedQuotesArray=e.data,App.saveMemorizedQuotes()},App.handleSaveAndMemorize=function(){App.closeUIWindow()},App.saveMemorizedQuotes=function(){Ti.API.info("App.saveMemorizedQuotes 1");var e=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,"memorizedQuotes.txt");e.exists()||Ti.API.info("File "+e.name+" does not exist yet."),Ti.API.info("writeable = "+e.writeable),Ti.API.info("readonly = "+e.readonly);for(var t="",o=0;o<App.data.memorizedQuotesArray.length;o++)Ti.API.info("App.saveMemorizedQuotes loop: "+o),t+=App.data.memorizedQuotesArray[o],o<App.data.memorizedQuotesArray.length-1&&(t+=",");e.write(t),Ti.API.info("here is revised memorized the text file: "+t)},App.sendMemorizedArray=function(){var e=Ti.Filesystem.getFile(Ti.Filesystem.applicationDataDirectory,"memorizedQuotes.txt");if(e.exists()){var t=e.read();Ti.API.info("memorized quotes array = "+t.text),Ti.App.fireEvent("MemorizedQuotesArraySent",{data:t.text})}else Ti.API.info("File "+e.name+" does not exist yet.")},App.handleTitaniumOrientationChange=function(e){Ti.API.info("orientationchange: "+e.orientation),App.data.height=(TiUtils.isAndroid(),TiUtils.getAppHeight()),App.data.width=TiUtils.getAppWidth(),-App.data.width,App.data.orientation="portrait"===TiUtils.getOrientation()?"portrait":"landscape",Ti.API.info(" gesture App.data.currMode: "+App.data.currMode),App.updateLayout(),Ti.App.fireEvent("orientationChangeEvent",{orientation:App.data.orientation})},App.handleTitaniumCloseInstructions=function(){Ti.API.info("closeInstructions")},App.handleTitaniumNetworkChange=function(){var e=Ti.Network.online;Ti.App.fireEvent("networkOnline",{online:e})},App.emailQuote=function(){"game"==App.data.currMode?(Titanium.API.info("emailQuote1"),App.data.currentQuote.isSaved?App.sendQuoteToServer(App.data.currentQuote.quote,App.data.currentQuote.author,App.data.currentQuote.reference,App.data.currentQuote.language):App.showEmailQuoteDialog(App.data.currentQuote.id)):TiUtils.showAlertDialog("Email Message","You need to select a quote first in order to send it.",["OK"])},App.sendQuoteToServer=function(e,t,o,i){var d=Ti.Network.createHTTPClient(),n={text:e,author:t,source:o,language:i};d.onload=function(){var e=this.responseText;App.showEmailQuoteDialog(e)},d.onerror=function(){App.showEmailQuoteDialog()},d.open("POST","http://www.imemorize.org/insert_quote.php"),d.send(n)},App.showEmailQuoteDialog=function(e){Titanium.API.info("App.showEmailQuoteDialog()1");var t="",o=App.data.currentQuote.quote,i=/<[^<>]+>/gi;o=o.replace(i,"\n"),Titanium.API.info("App.showEmailQuoteDialog()2");var d="I found this quote on iMemorize Mobile:\n\n";void 0!==App.data.currentQuote.introText&&(t=App.data.currentQuote.introText+"\n"),t=t+'"'+o+'" \n'+App.data.currentQuote.author+" | "+App.data.currentQuote.reference;var n="\n\n Go here to memorize this quote: http://www.imemorize.org/lite/?id="+e,a="\n\n Go here to download the app: http://www.imemorize.org/download.html",u=d+t+n+a;Titanium.API.info("App.showEmailQuoteDialog()3"),void 0===e&&(u=d+t+a),Titanium.API.info("App.showEmailQuoteDialog()4");var r=Ti.UI.createEmailDialog();r.subject="A quote from iMemorize Mobile",r.messageBody=u,r.open(),Titanium.API.info("App.showEmailQuoteDialog()5")},App.showEmailUsDialog=function(){var e="Feedback regarding iMemorize for iPhone/iPod Touch";TiUtils.isiPad()&&(e="Feedback regarding iMemorize for iPad");var t=Ti.UI.createEmailDialog();t.subject=e,t.messageBody="",t.toRecipients=["bkurzius@gmail.com"],t.open()},App.copyQuoteToClipboard=function(){if("game"==App.data.currMode){var e=App.data.currentQuote.quote,t=App.data.currentQuote.author,o=App.data.currentQuote.reference,i=/<[^<>]+>/gi;e=e.replace(i,"\n");var d=e+"\n"+t+" | "+o;Ti.UI.Clipboard.setText(d),Ti.API.info("copy the quote to the clipboard: "+d),TiUtils.showAlertDialog("Message","The quote has now been copied to the clipboard.",["OK"])}else TiUtils.showAlertDialog("Message","You need to select a quote first in order to copy it.",["OK"])},App.removeIdFromMemorizedArray=function(e){if(App.isInMemorizedArray(e)){Ti.API.info("isInMemorizedArray: true");for(var t=0;t<App.data.memorizedQuotesArray.length;t++)App.data.memorizedQuotesArray[t]===e&&App.data.memorizedQuotesArray.splice(t,1)}else Ti.API.info("isInMemorizedArray: false");App.saveMemorizedQuotes()},App.isInMemorizedArray=function(e){for(var t=0;t<App.data.memorizedQuotesArray.length;t++)if(App.data.memorizedQuotesArray[t]===e)return!0;return!1},App.showGameButtons=function(){mainWindow.add(App.ui.buttonbar),App.ui.buttonbar.visible=!0},App.hideGameButtons=function(){Ti.API.info("hideGameButtons()"),App.ui.buttonbar.visible=!1},Ti.API.info("start5"),App.init();